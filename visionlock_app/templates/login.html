<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VisionLock - Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: url("{% static 'images/BG-image.jpg' %}") no-repeat center center fixed;
      background-size: cover;
      height: 100vh;
      margin: 0;
    }
    .login-box {
      backdrop-filter: blur(10px);
      background: rgba(0, 0, 50, 0.4);
      border-radius: 20px;
      padding: 2rem 3rem;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
      color: white;
      width: 100%;
      max-width: 450px;
    }
    .btn, input, .form-control {
      border-radius: 10px;
    }
  </style>
</head>
<body class="d-flex align-items-center justify-content-center">

<div class="login-box text-center">
  <h2 class="mb-4">üîê VisionLock Login</h2>

  <!-- Face Recognition -->
  <div class="mb-4">
    <button id="start-face" class="btn btn-outline-light w-100">1‚É£ Auto Detect Username</button>
    <input id="username-display" class="form-control mt-2" placeholder="Detected Username" readonly />
  </div>

  <!-- Morse PIN Input -->
  <div class="mb-4">
    <button id="start-morse" class="btn btn-outline-light w-100">‚è∫ Start Morse PIN</button>
    <button id="erase-digit" class="btn btn-danger w-100 mt-2">‚å´ Erase Last Digit</button>
    <div id="morse-display" class="form-control mt-2 text-warning fw-bold" style="min-height:40px"></div>
    <input id="morse-output" type="hidden" />
  </div>

  <!-- Submit -->
  <button id="login-btn" class="btn btn-primary w-100">Login</button>

  <hr class="my-4" />
  <button id="reset-pin-btn" class="btn btn-warning w-100">Forgot PIN?</button>

  <video id="video-stream" width="320" height="240" autoplay muted style="display:none;"></video>
  <canvas id="face-canvas" style="display:none;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script>
  const video = document.getElementById("video-stream");
  const canvas = document.getElementById("face-canvas");
  const ctx = canvas.getContext("2d");

  let morseDigits = [], currentSymbolSequence = [], blinkDetector;
  const EAR_THRESHOLD = 0.2, BLINK_DURATION = 150;
  let blinkStart = null;

  const morseMap = {
    "....": "0", "..._": "1", ".._.": "2", "..__": "3",
    "._..": "4", "._._": "5", ".__.": "6", ".___": "7",
    "_...": "8", "_.._": "9"
  };

  function getEAR(landmarks) {
    const vertical1 = distance(landmarks[159], landmarks[145]);
    const vertical2 = distance(landmarks[386], landmarks[374]);
    const horizontal = distance(landmarks[33], landmarks[133]);
    return ((vertical1 + vertical2) / (2.0 * horizontal));
  }
  function distance(a, b) {
    return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
  }
  function showDigitTemporarily(digit) {
    const display = document.getElementById("morse-display");
    display.innerText = digit;
    setTimeout(() => display.innerText = "", 1000);
  }

  async function captureSnapshotAndAlert(username) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.muted = true;
      video.play();

      await new Promise(resolve => video.onloadeddata = () => resolve());
      await new Promise(resolve => setTimeout(resolve, 1500));

      if (video.videoWidth === 0 || video.videoHeight === 0) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const snapshot = canvas.toDataURL("image/jpeg");
      stream.getTracks().forEach(track => track.stop());
      video.srcObject = null;

      await fetch("/api/alert-admin/", {
        method: "POST",
        body: JSON.stringify({ image: snapshot, username: username || "Unknown" }),
        headers: { "Content-Type": "application/json" }
      });
    } catch (err) {
      console.error("Snapshot error:", err);
    }
  }

  function processBlink(symbol) {
    if (morseDigits.length >= 4) return;
    currentSymbolSequence.push(symbol);
    document.getElementById("morse-display").innerText += symbol;
    if (currentSymbolSequence.length === 4) {
      const code = currentSymbolSequence.join("");
      const digit = morseMap[code];
      if (digit !== undefined) {
        morseDigits.push(digit);
        document.getElementById("morse-output").value = morseDigits.join("");
        currentSymbolSequence = [];
        showDigitTemporarily(digit);
      } else {
        alert("Invalid Morse code: " + code);
        currentSymbolSequence = [];
        document.getElementById("morse-display").innerText = "";
      }
    }
    if (morseDigits.length === 4) {
      alert("‚úÖ Morse PIN captured");
      blinkDetector.stop();
      stopCapture(video.srcObject);
    }
  }

  const faceMesh = new window.FaceMesh({
    locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });
  faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
  faceMesh.onResults(results => {
    if (results.multiFaceLandmarks.length > 0) {
      const landmarks = results.multiFaceLandmarks[0];
      const ear = getEAR(landmarks);
      const now = performance.now();
      if (ear < EAR_THRESHOLD) {
        if (!blinkStart) blinkStart = now;
      } else {
        if (blinkStart) {
          const duration = now - blinkStart;
          blinkStart = null;
          processBlink(duration < BLINK_DURATION ? "." : "_");
        }
      }
    }
  });

  document.getElementById("start-morse").addEventListener("click", async () => {
    morseDigits = [];
    currentSymbolSequence = [];
    document.getElementById("morse-display").innerText = "";
    document.getElementById("morse-output").value = "";
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    video.style.display = "block";
    blinkDetector = new Camera(video, {
      onFrame: async () => await faceMesh.send({ image: video }),
      width: 320,
      height: 240
    });
    blinkDetector.start();
  });

  function stopCapture(stream) {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      video.style.display = "none";
    }
  }

  document.getElementById("erase-digit").addEventListener("click", () => {
    if (morseDigits.length > 0) {
      morseDigits.pop();
      document.getElementById("morse-output").value = morseDigits.join("");
      currentSymbolSequence = [];
      document.getElementById("morse-display").innerText = "";
    }
  });

  document.getElementById("start-face").addEventListener("click", async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    video.style.display = "block";
    setTimeout(() => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imageData = canvas.toDataURL("image/jpeg");
      stopCapture(stream);
      fetch("/api/match-face/", {
        method: "POST",
        body: JSON.stringify({ image: imageData }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.username) {
          document.getElementById("username-display").value = data.username;
          alert("‚úÖ Face recognized: " + data.username);
        } else {
          alert("‚ùå Face not recognized");
        }
      });
    }, 3000);
  });

  document.getElementById("login-btn").addEventListener("click", async () => {
    const username = document.getElementById("username-display").value.trim();
    const pin = document.getElementById("morse-output").value.trim();
    if (!username || !pin) return alert("Please complete all fields.");

    const res = await fetch("/api/verify-login/", {
      method: "POST",
      body: JSON.stringify({ username, morse_pin: pin }),
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    if (data.status === "success") {
      sessionStorage.setItem("autoLogout", "true");
      window.location.href = "https://myportfolio-5tb9.onrender.com/";
    } else {
      alert("‚ùå Login failed: " + data.message);
      await captureSnapshotAndAlert(username);
    }
  });

  document.getElementById("reset-pin-btn").addEventListener("click", () => {
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      video.style.display = "block";
      setTimeout(() => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const imageData = canvas.toDataURL("image/jpeg");
        stopCapture(stream);
        fetch("/api/match-face/", {
          method: "POST",
          body: JSON.stringify({ image: imageData }),
          headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
          if (!data.username) return alert("‚ùå Face not recognized");
          const new_pin = prompt("Enter your new 4-digit Morse PIN (e.g. 1234):");
          if (!new_pin || new_pin.length !== 4) return alert("Invalid new PIN");
          fetch("/api/reset-pin/", {
            method: "POST",
            body: JSON.stringify({ image: imageData, new_pin }),
            headers: { "Content-Type": "application/json" }
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              alert("üîÅ PIN reset successful!");
            } else {
              alert("‚ùå Reset failed: " + data.message);
            }
          });
        });
      }, 3000);
    });
  });
</script>
</body>
</html>
